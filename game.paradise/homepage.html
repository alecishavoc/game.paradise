<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Home | Game Paradise</title>
  <style>
    :root {
      --bg: #0b0b0b;
      --surface: #121212;
      --text: #eaeaea;
      --accent: #3aa0ff;
      --border: #222;
      --radius: 10px;
      /* Default Logic Variables */
      --glow: none;
      --blur: 0px;
      --modal-bg: var(--surface);
    }

    body, html {
      margin: 0; padding: 0;
      height: 100%; width: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', Arial, sans-serif;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    /* ---------- App Bar ---------- */
    .app-bar {
      display: flex; justify-content: space-between; align-items: center;
      background: rgba(0,0,0,0.2); padding: 10px 20px; height: 60px; box-sizing: border-box;
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(10px);
    }
    .nav { display: flex; align-items: center; gap: 20px; }
    .nav a { color: var(--text); text-decoration: none; font-weight: bold; font-size: 14px; transition: color 0.3s; }
    .nav a.active { color: var(--accent); }
    .nav a:hover { color: var(--accent); }

    .profile-trigger { display: flex; align-items: center; cursor: pointer; }
    .pfp-small { 
      width: 32px; height: 32px; border-radius: 50%; 
      border: 1px solid var(--accent); 
      background-size: cover; background-position: center;
      box-shadow: var(--glow);
    }

    /* ---------- Friends Bar ---------- */
    .friends-container { 
      background: transparent; padding: 20px 30px; 
      border-bottom: 1px solid var(--border); 
    }
    .friends-row { display: flex; gap: 20px; overflow-x: auto; align-items: center; }
    .friends-row::-webkit-scrollbar { display: none; }

    .friend-card { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; flex-shrink: 0; width: 80px; }
    .hollow-circle { 
      position: relative; width: 70px; height: 70px; border-radius: 50%; 
      border: 1px solid var(--border); padding: 4px; 
      display: flex; align-items: center; justify-content: center; transition: 0.2s;
    }
    .hollow-circle:hover { border-color: var(--accent); transform: scale(1.05); box-shadow: var(--glow); }
    .hollow-circle img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
    
    .add-btn-circle { border: 1px dashed var(--accent); color: var(--accent); font-size: 28px; }
    .friend-dot { position: absolute; bottom: 4px; right: 4px; width: 12px; height: 12px; border-radius: 50%; border: 2px solid var(--bg); }
    /* Green for Active */
    .status-active { background: #2ecc71; box-shadow: 0 0 8px #2ecc71; }
    /* Yellow for Idle/AFK */
    .status-idle { background: #f1c40f; box-shadow: 0 0 8px #f1c40f; }
    /* Gray for Offline */
    .status-offline { background: #7f8c8d; }

    /* ---------- Modal ---------- */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 1000; }
    .social-modal { 
      background: var(--modal-bg); 
      backdrop-filter: blur(var(--blur)); 
      -webkit-backdrop-filter: blur(var(--blur));
      width: 450px; border: 1px solid var(--border); border-radius: var(--radius); 
      overflow: hidden; 
      box-shadow: var(--glow);
    }
    .modal-tabs { display: flex; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.2); }
    .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; color: #666; font-weight: bold; font-size: 12px; }
    .tab.active { color: var(--accent); background: rgba(255,255,255,0.05); }
    
    .modal-body { padding: 30px; text-align: center; }
    input[type="text"] { 
      width: 100%; padding: 10px; background: rgba(0,0,0,0.3); 
      border: 1px solid var(--border); color: var(--text); 
      margin-bottom: 15px; border-radius: var(--radius); outline: none;
    }
    
    .button { 
      padding: 10px 15px; border-radius: var(--radius); border: none;
      background: var(--accent); 
      color: white; font-weight: 600; cursor: pointer; width: 100%; 
      transition: opacity 0.2s;
    }
    .button:hover { opacity: 0.8; }

    .view-pfp { width: 100px; height: 100px; border-radius: 50%; border: 2px solid var(--accent); margin-bottom: 10px; box-shadow: var(--glow); }
    .view-bio { background: rgba(0,0,0,0.2); padding: 12px; border-radius: var(--radius); margin: 15px 0; font-size: 13px; border: 1px solid var(--border); }
    
    /* Search/Request Result Styles */
    .user-result-item {
        display: flex; align-items: center; gap: 15px; background: rgba(255,255,255,0.03); 
        padding: 12px; border-radius: 8px; margin-bottom: 10px; text-align: left; border: 1px solid var(--border);
    }
    .result-pfp { width: 45px; height: 45px; border-radius: 50%; border: 1px solid var(--accent); flex-shrink: 0; }
    .result-info { flex-grow: 1; overflow: hidden; }
    .result-name { font-weight: bold; font-size: 14px; display: block; color: var(--accent); }
    .result-bio-snippet { font-size: 11px; opacity: 0.6; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* ---------- Footer ---------- */
    .site-footer {
      position: fixed; bottom: 0; width: 100%; height: 50px; background: rgba(0,0,0,0.4);
      border-top: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between;
      padding: 0 20px; box-sizing: border-box; font-size: 12px; backdrop-filter: blur(10px);
    }

    .version-display { cursor: pointer; color: var(--accent); font-weight: bold; }
    /* ---------- Loading Screen ---------- */
    #loadingScreen {
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background: var(--bg);
      /* Support for Glass Mode Blur */
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      display: flex; align-items: center; justify-content: center;
      z-index: 9999;
      transition: opacity 0.3s ease, visibility 0.3s;
    }
    .loader-content { text-align: center; display: flex; flex-direction: column; align-items: center; gap: 20px; }
    .spinner {
      width: 40px; height: 40px;
      border: 3px solid rgba(255,255,255,0.1);
      border-top: 3px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      /* Support for Accent Color Glow */
      box-shadow: var(--glow);
    }
    #loadingMessage {
      color: var(--text); font-size: 14px; font-weight: bold;
      letter-spacing: 1px; text-transform: uppercase; opacity: 0.8;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .loader-hidden { opacity: 0; visibility: hidden; }
  </style>
</head>
<body>
  <div id="loadingScreen">
    <div class="loader-content">
      <div class="spinner"></div>
      <div id="loadingMessage">Initializing...</div>
    </div>
  </div>

  <div class="app-bar">
    <div class="nav">
      <a href="homepage.html" class="active">Home</a>
      <a href="games.html">Games</a>
      <a href="settings.html">Settings</a>
      <a href="proxy.html">Proxy</a>
      <a href="chat.html">Chat</a>
      <a href="media.html">Media</a>
    </div>
    <div class="profile-trigger" onclick="location.href='profile.html'">
        <div id="userProfilePic" class="pfp-small"></div>
    </div>
  </div>

  <div class="friends-container">
    <div id="friendsRow" class="friends-row">
        <div class="friend-card" onclick="openSocialHub()">
            <div class="hollow-circle add-btn-circle">+</div>
            <span style="font-size:10px; margin-top:4px; font-weight: bold; color: var(--accent);">SOCIAL</span>
        </div>
    </div>
  </div>

  <div id="socialModal" class="modal-overlay">
    <div class="social-modal">
      <div class="modal-tabs" id="tabBar">
        <div class="tab active" id="searchTab" onclick="switchTab('search')">FIND</div>
        <div class="tab" id="requestTab" onclick="switchTab('requests')">REQUESTS</div>
        <div class="tab" style="max-width:50px;" onclick="closeModal()">‚úï</div>
      </div>
      <div id="modalContent" class="modal-body"></div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="version-display" onclick="openChangelog()">v0.0.0</div>
    <div style="opacity: 0.5;">&copy; 2026 Game Paradise. Perpetual Ownership.</div>
  </footer>

  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>

  <script>
    function triggerLoadingScreen() {
        const loader = document.getElementById('loadingScreen');
        const msgLabel = document.getElementById('loadingMessage');
        
        // Track visit count for weighted logic
        let visitCount = parseInt(localStorage.getItem('site_visit_count') || '0');
        visitCount++;
        localStorage.setItem('site_visit_count', visitCount);

        const messageData = [
            { text: "If you got school work dont be on this please go finish your work", weight: (visitCount <= 3 ? 70 : 15) },
            { text: "Check settings extra tab ill be accepting game request (DONT ADD ALREADY EXISTING GAMES OR VIRUSES OR NON-HTML GAMES)", weight: 25 },
            { text: "This is a placeholder for the newest meme i gotta ask my friend for the newest ones", weight: 30 },
            { text: "What should i add to the site? check settings/extra", weight: 30 }
        ];

        // Weighted Selection Logic
        let totalWeight = messageData.reduce((sum, m) => sum + m.weight, 0);
        let random = Math.random() * totalWeight;
        let selected = messageData[0].text;

        for (const msg of messageData) {
            if (random < msg.weight) {
                selected = msg.text;
                break;
            }
            random -= msg.weight;
        }

        msgLabel.innerText = selected;

        setTimeout(() => {
            loader.classList.add('loader-hidden');
        }, 1000);
    }
    const firebaseConfig = {
        apiKey: "AIzaSyAgsZ68VNL-b5AsWnzll2g_C1Yhw7IowlY",
        authDomain: "gameparadiserawdata.firebaseapp.com",
        projectId: "gameparadiserawdata",
        appId: "1:6326540558:web:8115f5520f0737b239df5f"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const rtdb = firebase.database();

    let selectedId = null;

// üï∂Ô∏è Incognito flag
const isIncognito = new URLSearchParams(window.location.search).has('incognito');

// Preserve incognito mode across page navigation
if (isIncognito) {
    document.querySelectorAll('.nav a').forEach(link => {
        const url = new URL(link.href);
        url.searchParams.set('incognito', '1');
        link.href = url.toString();
    });
    
    // Also update profile trigger
    const profileTrigger = document.querySelector('.profile-trigger');
    if (profileTrigger) {
        profileTrigger.onclick = () => location.href = 'profile.html?incognito=1';
    }
}

    function loadUserTheme(uid) {
        return db.collection("users").doc(uid).collection("settings").doc("appearance").get().then(doc => {
            if (doc.exists) {
                const data = doc.data();
                const root = document.documentElement;

                // 1. Base Theme Configuration Logic
                switch(data.themePreset) {
                    // --- BASIC THEMES ---
                    case 'red': root.style.setProperty('--bg', '#1a0505'); root.style.setProperty('--surface', '#250a0a'); root.style.setProperty('--border', '#451515'); break;
                    case 'blue': root.style.setProperty('--bg', '#050a1a'); root.style.setProperty('--surface', '#0a1425'); root.style.setProperty('--border', '#152545'); break;
                    case 'green': root.style.setProperty('--bg', '#051a05'); root.style.setProperty('--surface', '#0a250a'); root.style.setProperty('--border', '#154515'); break;
                    case 'yellow': root.style.setProperty('--bg', '#1a1a05'); root.style.setProperty('--surface', '#25250a'); root.style.setProperty('--border', '#454515'); break;
                    case 'orange': root.style.setProperty('--bg', '#1a1005'); root.style.setProperty('--surface', '#25150a'); root.style.setProperty('--border', '#452515'); break;
                    case 'purple': root.style.setProperty('--bg', '#10051a'); root.style.setProperty('--surface', '#150a25'); root.style.setProperty('--border', '#251545'); break;
                    case 'pink': root.style.setProperty('--bg', '#1a0510'); root.style.setProperty('--surface', '#250a15'); root.style.setProperty('--border', '#451525'); break;
                    case 'black': root.style.setProperty('--bg', '#000000'); root.style.setProperty('--surface', '#080808'); root.style.setProperty('--border', '#111'); break;
                    case 'white': root.style.setProperty('--bg', '#f0f0f0'); root.style.setProperty('--surface', '#ffffff'); root.style.setProperty('--border', '#ccc'); break;
                    case 'gray': root.style.setProperty('--bg', '#1a1a1a'); root.style.setProperty('--surface', '#222222'); root.style.setProperty('--border', '#333'); break;
                    
                    // --- ADVANCED THEMES ---
                    case 'cyberpunk': root.style.setProperty('--bg', '#000000'); root.style.setProperty('--surface', '#0a0a1a'); root.style.setProperty('--border', '#ff0055'); break;
                    case 'nordic': root.style.setProperty('--bg', '#2e3440'); root.style.setProperty('--surface', '#3b4252'); root.style.setProperty('--border', '#4c566a'); break;
                    case 'amethyst': root.style.setProperty('--bg', '#0f051a'); root.style.setProperty('--surface', '#180a25'); root.style.setProperty('--border', '#351545'); break;
                    case 'midnight': root.style.setProperty('--bg', '#020205'); root.style.setProperty('--surface', '#050510'); root.style.setProperty('--border', '#101030'); break;
                    case 'matrix': root.style.setProperty('--bg', '#000500'); root.style.setProperty('--surface', '#001000'); root.style.setProperty('--border', '#00ff41'); break;
                    case 'oceanic': root.style.setProperty('--bg', '#010b13'); root.style.setProperty('--surface', '#021627'); root.style.setProperty('--border', '#032b4d'); break;
                    case 'lava': root.style.setProperty('--bg', '#100000'); root.style.setProperty('--surface', '#200000'); root.style.setProperty('--border', '#ff4500'); break;
                    case 'vaporwave': root.style.setProperty('--bg', '#1a0033'); root.style.setProperty('--surface', '#2d0059'); root.style.setProperty('--border', '#ff71ce'); break;
                    case 'forest': root.style.setProperty('--bg', '#0a1005'); root.style.setProperty('--surface', '#15200a'); root.style.setProperty('--border', '#2d4d1a'); break;
                    case 'space': root.style.setProperty('--bg', '#05000a'); root.style.setProperty('--surface', '#0b001a'); root.style.setProperty('--border', '#4b0082'); break;
                    
                    default: // Dark Default
                        root.style.setProperty('--bg', '#0b0b0b');
                        root.style.setProperty('--surface', '#121212');
                        root.style.setProperty('--border', '#222');
                }

                // 2. Overlays, Accents, and Text Color
                if (data.accentColor) root.style.setProperty('--accent', data.accentColor);
                if (data.textColor) root.style.setProperty('--text', data.textColor); // NEW LINE

                // 2. Overlays & Accents
                if (data.accentColor) root.style.setProperty('--accent', data.accentColor);
                if (data.textColor) root.style.setProperty('--text', data.textColor); // THIS IS THE NEW LINE

                if (data.borderGlow) {
                    root.style.setProperty('--glow', `0 0 15px ${data.accentColor || 'var(--accent)'}`);
                } else {
                    root.style.setProperty('--glow', 'none');
                }

                if (data.glassMode) {
                    root.style.setProperty('--blur', '20px');
                    root.style.setProperty('--modal-bg', 'rgba(15, 15, 15, 0.7)');
                } else {
                    root.style.setProperty('--blur', '0px');
                    root.style.setProperty('--modal-bg', 'var(--surface)');
                }
            }
        });
    }

auth.onAuthStateChanged(async user => {
    triggerLoadingScreen();

    // üï∂Ô∏è INCOGNITO MODE (no Firebase usage)
    if (!user && isIncognito) {
        console.log("Incognito mode active");

        // Neutral profile icon
        const pfp = document.getElementById('userProfilePic');
        pfp.style.backgroundImage = 'none';
        pfp.style.border = '1px dashed var(--border)';

        // Replace friends bar
        document.getElementById('friendsRow').innerHTML = `
            <div class="friend-card">
                <div class="hollow-circle add-btn-circle">üëª</div>
                <span style="font-size:10px; font-weight:bold; opacity:.5;">INCOGNITO</span>
            </div>
        `;

        return; // ‚õî DO NOT TOUCH FIREBASE
    }

    // üîê NORMAL LOGGED-IN USER
    if (user) {
        await loadUserTheme(user.uid);

        updateStatus('active');
        const doc = await db.collection("users").doc(user.uid).get();
        if (doc.exists) {
            document.getElementById('userProfilePic').style.backgroundImage =
                `url('${doc.data().photoURL}')`;
        }
        loadFriends(user);
    } else {
        window.location.href = "index.html";
    }
});


    // --- Social Engine ---
   function openSocialHub() { 
  if (isIncognito) {
    alert("Social features are disabled in Incognito Mode.");
    return;
  }
  document.getElementById('socialModal').style.display = 'flex'; 
  document.getElementById('tabBar').style.display = 'flex';
  switchTab('search'); 
}

    
    function closeModal() { document.getElementById('socialModal').style.display = 'none'; }

    async function switchTab(tab) {
        const content = document.getElementById('modalContent');
        document.getElementById('searchTab').className = tab === 'search' ? 'tab active' : 'tab';
        document.getElementById('requestTab').className = tab === 'requests' ? 'tab active' : 'tab';

        if(tab === 'search') {
            content.innerHTML = `<input type="text" id="searchInput" placeholder="Username or Email..." onkeydown="if(event.key==='Enter') doSearch()"><div id="results"></div>`;
        } else {
            const snap = await db.collection("users").doc(auth.currentUser.uid).collection("friends").where("added", "==", "pending").get();
            content.innerHTML = snap.empty ? '<p style="color:#666; font-size: 13px;">No pending requests.</p>' : '';
            snap.forEach(async d => {
                const u = await db.collection("users").doc(d.id).get();
                if(!u.exists) return;
                const data = u.data();
                const bioSnippet = data.bio ? (data.bio.length > 50 ? data.bio.substring(0, 50) + "..." : data.bio) : "No bio available.";
                
                content.innerHTML += `
                <div class="user-result-item">
                    <img src="${data.photoURL}" class="result-pfp">
                    <div class="result-info">
                        <span class="result-name">${data.username}</span>
                        <span class="result-bio-snippet">${bioSnippet}</span>
                    </div>
                    <div style="display:flex; gap:5px;">
                        <button class="button" style="width:auto; padding:5px 12px;" onclick="accept('${d.id}')">ACCEPT</button>
                        <button class="button" style="width:auto; padding:5px 12px; background:rgba(255,75,75,0.1); color:#ff4b4b; border:1px solid #422;" onclick="selectedId='${d.id}'; confirmAction('DECLINE')">‚úï</button>
                    </div>
                </div>`;
            });
        }
    }

    async function doSearch() {
        const term = document.getElementById('searchInput').value.trim().toLowerCase();
        const res = document.getElementById('results');
        
        // Search by username
        let snap = await db.collection("users").where("username", "==", term).get();
        
        // If username fails, try searching by email (gmail)
        if(snap.empty) {
            snap = await db.collection("users").where("email", "==", term).get();
        }

        res.innerHTML = snap.empty ? '<p style="color:#666; margin-top:10px;">User not found.</p>' : '';
        
        snap.forEach(doc => {
            if(doc.id === auth.currentUser.uid) return;
            const data = doc.data();
            const bioSnippet = data.bio ? (data.bio.length > 50 ? data.bio.substring(0, 50) + "..." : data.bio) : "No bio available.";

            res.innerHTML += `
            <div class="user-result-item">
                <img src="${data.photoURL}" class="result-pfp">
                <div class="result-info">
                    <span class="result-name">${data.username}</span>
                    <span class="result-bio-snippet">${bioSnippet}</span>
                </div>
                <button class="button" style="width:auto; padding:5px 12px;" onclick="sendReq('${doc.id}')">ADD</button>
            </div>`;
        });
    }

    async function sendReq(id) {
        // We add the 'uid' field here so the recipient knows who you are in their "Requests" tab
        await db.collection("users").doc(id).collection("friends").doc(auth.currentUser.uid).set({ 
            added: 'pending',
            uid: auth.currentUser.uid 
        });
        alert("Request Sent!");
        closeModal();
    }

    async function accept(id) {
        const myId = auth.currentUser.uid;
        const batch = db.batch();
        batch.update(db.collection("users").doc(myId).collection("friends").doc(id), { added: true });
        batch.set(db.collection("users").doc(id).collection("friends").doc(myId), { added: true }, { merge: true });
        await batch.commit();
        closeModal();
    }

    async function executeDecline() {
        await db.collection("users").doc(auth.currentUser.uid).collection("friends").doc(selectedId).delete();
        closeModal();
    }

    function loadFriends(user) {
        const row = document.getElementById('friendsRow');
        // ADDED .where("added", "==", true) so pending requests don't show up in the bar
        db.collection("users").doc(user.uid).collection("friends").where("added", "==", true).onSnapshot(snap => {
            row.innerHTML = `<div class="friend-card" onclick="openSocialHub()">
                <div class="hollow-circle add-btn-circle">+</div>
                <span style="font-size:10px; font-weight:bold; color: var(--accent);">SOCIAL</span>
            </div>`;
            snap.forEach(async d => {
                const u = await db.collection("users").doc(d.id).get();
                if(!u.exists) return;
                const card = document.createElement('div');
                card.className = 'friend-card';
                card.onclick = () => openProfile(d.id);
                card.innerHTML = `<div class="hollow-circle"><img src="${u.data().photoURL}"><div class="friend-dot" id="d-${d.id}"></div></div>
                                  <span style="font-size:9px; font-weight:bold; color: var(--text); opacity: 0.7;">${u.data().username.toUpperCase()}</span>`;
                row.appendChild(card);
                rtdb.ref(`/status/${d.id}`).on('value', s => {
        const dot = document.getElementById(`d-${d.id}`);
        const status = s.val() || 'offline'; // Default to offline if no data
        if(dot) {
            // This now matches 'status-active', 'status-idle', or 'status-offline'
            dot.className = `friend-dot status-${status}`;
        }
    });
            });
        });
    }

    async function openProfile(id) {
        selectedId = id;
        document.getElementById('tabBar').style.display = 'none';
        document.getElementById('socialModal').style.display = 'flex';
        const u = await db.collection("users").doc(id).get();
        const data = u.data();

        document.getElementById('modalContent').innerHTML = `
            <img class="view-pfp" src="${data.photoURL}">
            <h2 style="margin:0; color:var(--accent);">${data.username}</h2>
            <div class="view-bio">${data.bio || 'No status bio available.'}</div>
            <div style="display:flex; gap:10px;">
                <button class="button" style="background:rgba(255,255,255,0.05); color: #ff4b4b; border: 1px solid #422;" onclick="confirmAction('UNFRIEND')">UNFRIEND</button>
                <button class="button" onclick="closeModal()">CLOSE</button>
            </div>
        `;
    }

    function confirmAction(type) {
        const content = document.getElementById('modalContent');
        content.innerHTML = `<h3 style="color: #ff4b4b;">Confirm ${type}?</h3>
            <p style="font-size: 12px; margin-bottom: 20px;">This action cannot be undone immediately.</p>
            <button id="timerBtn" class="button" disabled>Wait (3s)</button>
            <button class="button" style="background:transparent; margin-top:10px; color: var(--text);" onclick="openProfile('${selectedId}')">CANCEL</button>`;
        
        let count = 3;
        const itv = setInterval(() => {
            count--;
            const timerBtn = document.getElementById('timerBtn');
            if(timerBtn) timerBtn.innerText = `Wait (${count}s)`;
            if(count <= 0) {
                clearInterval(itv);
                const btn = document.getElementById('timerBtn');
                if(btn) {
                    btn.disabled = false;
                    btn.innerText = `CONFIRM ${type}`;
                    btn.onclick = () => {
                        if(type === 'UNFRIEND') executeUnfriend();
                        else if(type === 'DECLINE') executeDecline();
                        else closeModal();
                    };
                }
            }
        }, 1000);
    }

    async function executeUnfriend() {
        try {
            const batch = db.batch();
            batch.delete(db.collection("users").doc(auth.currentUser.uid).collection("friends").doc(selectedId));
            batch.delete(db.collection("users").doc(selectedId).collection("friends").doc(auth.currentUser.uid));
            await batch.commit();
            closeModal();
        } catch (error) {
            console.error("Error unfriending:", error);
            alert("Could not remove friend. Check your connection.");
        }
    }

    function openChangelog() {
      const modal = document.getElementById("socialModal");
      const tabBar = document.getElementById("tabBar");
      const content = document.getElementById("modalContent");
      modal.style.display = "flex";
      tabBar.style.display = "none";
      content.innerHTML = `
        <h2 style="margin-top:0; color: var(--accent);">Update v0.0.0</h2>
        <div class="changelog-list" style="text-align:left; max-height:300px; overflow-y:auto; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px;">
            <p><b>Place holder</b>: Added literally everything.</p>
            <p><b>Place holder</b>: this is the release so there is no update.</p>
            <p><b>Place holder</b>: Fixed theme sync across multiple pages.</p>
        </div>
        <button class="button" style="margin-top: 20px;" onclick="closeModal()">Great!</button>
      `;
    }
    // --- Activity & Presence Tracker ---
    let lastActivity = Date.now();
    const IDLE_TIMEOUT = 3 * 60 * 1000; // 3 minutes

   function updateStatus(status) {
    if (isIncognito || !auth.currentUser) return;
    const statusRef = rtdb.ref(`/status/${auth.currentUser.uid}`);
    
    statusRef.onDisconnect().set('offline');
    statusRef.set(status);
}


    // Monitor for user interactions
    ['mousedown', 'keydown', 'touchstart', 'mousemove'].forEach(evt => {
        window.addEventListener(evt, () => {
            if (Date.now() - lastActivity > 2000) { // Throttle to save database calls
                lastActivity = Date.now();
                updateStatus('active');
            }
        });
    });

    // Check for Idle status every 30 seconds
    setInterval(() => {
        if (Date.now() - lastActivity > IDLE_TIMEOUT) {
            updateStatus('idle');
        }
    }, 30000);
  </script>
</body>
</html>