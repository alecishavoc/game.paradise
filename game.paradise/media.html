<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Media Hub | Game Paradise</title>
  <style>
   :root {
      --bg: #0b0b0b;
      --surface: #121212;
      --text: #eaeaea;
      --accent: #3aa0ff;
      --border: #222;
      --radius: 12px;
    }

    body, html {
      margin: 0; padding: 0;
      background: var(--bg); color: var(--text);
      font-family: 'Segoe UI', sans-serif; overflow: hidden;
      height: 100%;
    }

    /* Custom Scrollbar */
    .media-container::-webkit-scrollbar { width: 8px; }
    .media-container::-webkit-scrollbar-track { background: var(--bg); }
    .media-container::-webkit-scrollbar-thumb { 
        background: var(--border); 
        border-radius: 10px; 
        border: 2px solid var(--bg);
    }
    .media-container::-webkit-scrollbar-thumb:hover { background: var(--accent); }

    /* ---------- App Bar ---------- */
    .app-bar {
      display: flex; justify-content: space-between; align-items: center;
      padding: 0 20px; height: 60px; border-bottom: 1px solid var(--border);
      background: rgba(0,0,0,0.2); backdrop-filter: blur(10px);
    }
    .nav { display: flex; gap: 20px; align-items: center; }
    .nav a { color: var(--text); text-decoration: none; font-weight: bold; font-size: 14px; opacity: 0.7; }
    .nav a.active { color: var(--accent); opacity: 1; }

    /* ---------- Controls ---------- */
    .media-controls {
      display: flex; justify-content: center; gap: 10px; padding: 15px 20px;
      background: rgba(255,255,255,0.02); align-items: center;
    }
    /* Enhanced 3D Flip & Perspective */
    .control-group { 
      display: flex; align-items: center; background: var(--surface); 
      border: 1px solid var(--border); border-radius: 8px; 
      perspective: 1000px; /* Added for 3D depth */
    }
    
    .dropdown-select {
      background: var(--surface); color: var(--text); border: none; padding: 8px 30px 8px 12px;
      font-size: 13px; cursor: pointer; outline: none; appearance: none;
      background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23eaeaea%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 10px auto;
      transition: all 0.3s ease;
    }

    /* Styles the dropdown list to match theme */
    .dropdown-select option { background: var(--surface); color: var(--text); }

    /* Only flip the arrow icon and change text color, keep text upright */
    .dropdown-select:focus { 
        color: var(--accent); 
        background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%233aa0ff%22%20d%3D%22M287%20223a17.6%2017.6%200%200%201-13%205.4H18.4c-5%200-9.3-1.8-12.9-5.4A17.6%2017.6%200%200%201%200%20210.2c0-5%201.8-9.3%205.4-12.9l128-127.9c3.6-3.6%207.8-5.4%2012.8-5.4s9.2%201.8%2012.8%205.4L287%20197.4c3.5%203.5%205.4%207.8%205.4%2012.8%200%205-1.9%209.2-5.5%2012.8z%22%2F%3E%3C%2Fsvg%3E");
    }

    .search-container {
      display: flex; align-items: center; background: var(--surface);
      border: 1px solid var(--border); border-radius: 8px; padding: 0 12px; width: 300px;
    }
    .search-container input {
      background: transparent; border: none; color: white; padding: 8px; width: 100%; outline: none;
    }

    /* ---------- Media Grid & Fluent Easing ---------- */
    .media-container {
      height: calc(100vh - 140px); 
      overflow-y: auto; 
      padding: 30px;
      display: grid; 
      gap: 25px; 
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      grid-auto-rows: min-content; /* Fixes card overlapping */
    }
    .media-container.banner-view { grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); }

    .media-card {
      position: relative; border-radius: var(--radius); overflow: hidden;
      cursor: pointer; background: var(--surface); 
      transition: transform 0.4s cubic-bezier(0.2, 0, 0.2, 1);
      aspect-ratio: 2/3;
      opacity: 0;
      animation: fluentFadeIn 0.6s ease forwards;
    }
    @keyframes fluentFadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .banner-view .media-card { aspect-ratio: 16/9; }
    .media-card:hover { transform: scale(1.04); }

    .media-img {
      width: 100%; height: 100%; object-fit: cover;
      transition: filter 0.4s ease;
    }
    .media-card:hover .media-img { filter: blur(10px) brightness(0.4); }
    .hover-overlay {
      position: absolute; inset: 0; display: flex; align-items: center;
      justify-content: center; opacity: 0; transition: opacity 0.4s;
      padding: 10px; text-align: center;
    }
    .media-card:hover .hover-overlay { opacity: 1; }
    .movie-title { font-weight: bold; font-size: 16px; color: white; }
.hover-content {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.movie-desc {
  font-size: 13px;
  line-height: 1.4;
  color: #ddd;
  max-height: 5.6em; /* ~4 lines */
  overflow: hidden;
}

    /* ---------- Player Centered UI ---------- */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.95);
      display: none; z-index: 2000;
    }
    .source-menu { display: flex; height: 100%; width: 100%; }
    .sidebar {
      width: 60px; border-right: 1px solid var(--border); display: flex;
      flex-direction: column; align-items: center; padding: 20px 0; gap: 20px;
      background: #080808;
    }
    .side-btn {
      width: 40px; height: 40px; border-radius: 8px; border: 1px solid var(--border);
      background: var(--surface); color: white; cursor: pointer; display: flex;
      align-items: center; justify-content: center; font-size: 18px; transition: 0.2s;
    }
    .side-btn:hover { border-color: var(--accent); color: var(--accent); }

    .tv-selector-bar {
        position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
        display: flex; gap: 15px; z-index: 3000; background: var(--surface);
        padding: 5px 15px; border-radius: 50px; border: 1px solid var(--border);
        box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    }
    
    .tv-selector-bar select {
        background: transparent; color: var(--accent); border: none;
        font-weight: bold; outline: none; cursor: pointer;
    }

    .main-content { flex: 1; padding: 0; position: relative; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .close-btn { position: absolute; top: 20px; right: 20px; font-size: 24px; cursor: pointer; color: white; z-index: 3001; text-shadow: 0 0 10px rgba(0,0,0,1); }
    #playerFrame { width: 100%; height: 100%; aspect-ratio: 16 / 9; max-height: 100vh; }
    /* Ensures sidebar selects match the circular/square button style */
    #tvSideControls select {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      text-align: center;
      text-align-last: center;
    }
    .profile-trigger {
  display: flex;
  align-items: center;
  cursor: pointer;
}

.pfp-small {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: 1px solid var(--accent);
  background-size: cover;
  background-position: center;
}

  </style>
</head>
<body>

  <div class="app-bar">
    <div class="nav">
      <a href="homepage.html">Home</a>
      <a href="games.html">Games</a>
      <a href="proxy.html" class="active">Media</a>
      <a href="settings.html">Settings</a>
      <a href="chat.html">Chat</a>
      <a href="media.html">Media</a>
    </div>
    <div class="profile-trigger" onclick="location.href='profile.html'">
  <div id="userProfilePic" class="pfp-small"></div>
</div>
  </div>

  <div class="media-controls">
    <div class="control-group">
      <select class="dropdown-select" id="mediaType" onchange="fetchMovies()">
        <option value="movie">Movies</option>
        <option value="tv">TV Shows</option>
        <option value="YouTube">YouTube</option>
        <option value="Twitch">Twitch</option>
      </select>
    </div>

    <div class="search-container">
      <input type="text" id="movieSearch" placeholder="Search Movies..." onkeydown="if(event.key==='Enter') fetchMovies(this.value)">
    </div>

    <div class="control-group">
      <select class="dropdown-select" onchange="toggleView(this.value)">
        <option value="poster">Poster</option>
        <option value="banner">Banner</option>
      </select>
    </div>

    <div class="control-group">
        <select class="dropdown-select" id="proxyStatus" onchange="fetchMovies()">
          <option value="uv">Proxied</option>
          <option value="none">Non-Proxied</option>
        </select>
      </div>
  </div>

  <div class="media-container" id="mediaGrid"></div>

  <div class="modal-overlay" id="sourceModal">
    <div class="source-menu">
      <div class="source-menu">
      <div class="sidebar">
        <button class="side-btn" onclick="closeMenu()">‚Üê</button>
        
        <div id="tvSideControls" style="display:none; flex-direction:column; gap:10px;">
           <select id="seasonSelect" class="side-btn" style="width:50px; font-size:12px; padding:0;" onchange="fetchEpisodes()"></select>
           <select id="episodeSelect" class="side-btn" style="width:50px; font-size:12px; padding:0;" onchange="updatePlayerSource()"></select>
        </div>

        <div class="dropdown" style="position: relative;">
          <button class="side-btn" onclick="toggleSourcePicker()">üìÅ</button>
          <div class="dropdown-content" id="sourcePicker" style="left: 65px; top: 0; min-width: 220px; position: absolute; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; z-index: 3000; display: none; flex-direction: column; padding: 10px;">
            </div>
        </div>
        
        <button class="side-btn" onclick="toggleIframeFullscreen()" style="margin-top: auto;">‚§¢</button>
      </div>

      <div class="main-content">
        <div class="close-btn" onclick="closeMenu()">√ó</div>
        <iframe id="playerFrame" style="width: 100%; height: 100%; border: none; display: none;" allowfullscreen></iframe>
        <div id="placeholderView" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center;">
            <h2 id="menuTitle">Select a Source</h2>
            <p style="opacity: 0.5;">Click the folder icon in the sidebar to pick a server.</p>
        </div>
      </div>
    </div>
  </div>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
  apiKey: "AIzaSyAgsZ68VNL-b5AsWnzll2g_C1Yhw7IowlY",
  authDomain: "gameparadiserawdata.firebaseapp.com",
  projectId: "gameparadiserawdata",
  appId: "1:6326540558:web:8115f5520f0737b239df5f"
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

    function truncateText(text, maxLength = 140) {
    if (!text) return "No description available.";
    return text.length > maxLength
        ? text.slice(0, maxLength).trim() + "..."
        : text;
}
// Check if a movie is rated R (US)
async function isRatedR(movieId) {
  try {
    const res = await fetch(
      `https://api.themoviedb.org/3/movie/${movieId}/release_dates?api_key=${API_KEY}`
    );
    const data = await res.json();

    const us = data.results.find(r => r.iso_3166_1 === "US");
    if (!us) return false;

    return us.release_dates.some(r => r.certification === "R");
  } catch (e) {
    // Fail open (show movie if rating can't be checked)
    return false;
  }
}

    const API_KEY = '0c7387ed17fe3d2959530a2f0ca70022';
let currentView = 'poster';
let activeId = null;

// Ultraviolet XOR 2 Encoder
function encodeUV(str) {
    if (!str) return str;
    return encodeURIComponent(str.split('').map((char, ind) => ind % 2 ? String.fromCharCode(char.charCodeAt(0) ^ 2) : char).join(''));
}

const availableSources = [
  {
    id: "vidsrcxyz",
    name: "VidSrcXyz",
    urls: {
      movie: "https://vidsrc-embed.ru/embed/movie?tmdb={id}",
      tv: "https://vidsrc-embed.ru/embed/tv?tmdb={id}&season={season}&episode={episode}",
    },
  },
  {
    id: "mapletv",
    name: "Maple Tv (recomended)",
    urls: {
      movie: "https://mappletv.uk/watch/movie/{id}",
      tv: "https://mappletv.uk/watch/tv/{id}-{season}-{episode}",
    },
  },
  {
  id: "vidify",
  name: "Vidify",
  urls: {
    movie: "https://vidify.top/movie/{id}",
    tv: "https://vidify.top/tv/{id}/{season}/{episode}",
  },
},

  {
    id: "vidlinkpro",
    name: "VidLink Pro",
    urls: {
      movie: "https://vidlink.pro/movie/{id}?autoplay=true&poster=true&primaryColor=4da8ff",
      tv: "https://vidlink.pro/tv/{id}/{season}/{episode}?autoplay=false&poster=true&primaryColor=4da8ff",
    },
  },
  {
    id: "vidsrcco",
    name: "VidSrcCo (Server 2)",
    urls: {
      movie: "https://player.vidsrc.co/embed/movie/{id}?server=2",
      tv: "https://player.vidsrc.co/embed/tv/{id}/{season}/{episode}?server=2",
    },
  },
  {
    id: "autoembed",
    name: "AutoEmbed",
    urls: {
      movie: "https://player.autoembed.cc/embed/movie/{id}?server=1",
      tv: "https://player.autoembed.cc/embed/tv/{id}/{season}/{episode}",
    },
  },
  {
    id: "vidsrcicu",
    name: "VidSrcIcu",
    urls: {
      movie: "https://vidsrc.icu/embed/movie/{id}",
      tv: "https://vidsrc.icu/embed/tv/{id}/{season}/{episode}",
    },
  },
  {
    id: "vidsrccc",
    name: "VidSrcCC (v2)",
    urls: {
      movie: "https://vidsrc.cc/v2/embed/movie/{id}",
      tv: "https://vidsrc.cc/v2/embed/tv/{id}/{season}/{episode}",
    },
  },
  {
    id: "embedsu",
    name: "EmbedSU",
    urls: {
      movie: "https://embed.su/embed/movie/{id}",
      tv: "https://embed.su/embed/tv/{id}/{season}/{episode}",
    },
  },
  {
    id: "vidora",
    name: "Vidora",
    urls: {
      movie: "https://vidora.su/movie/{id}?colour=4da8ff&autoplay=true",
      tv: "https://vidora.su/tv/{id}/{season}/{episode}?colour=4da8ff&autoplay=true",
    },
  },
];

async function fetchMovies(query = null) {
¬† ¬† const type = document.getElementById('mediaType').value;
¬† ¬† const grid = document.getElementById('mediaGrid');
¬† ¬† const searchInput = document.getElementById('movieSearch');
    
    // Use the passed query or grab the text currently in the search box
    const searchTerm = query !== null ? query : searchInput.value;
¬† ¬† 
¬† ¬† const labels = { 'movie': 'Movies', 'tv': 'TV Shows', 'YouTube': 'YouTube', 'Twitch': 'Twitch' };
¬† ¬† searchInput.placeholder = `Search ${labels[type] || 'Media'}...`;

¬† ¬† // Handle Social Platforms manually
¬† ¬† if (type === 'YouTube' || type === 'Twitch') {
¬† ¬† ¬† ¬† const proxyStatus = document.getElementById('proxyStatus').value;
¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† // Social platform data
¬† ¬† ¬† ¬† const socialData = type === 'YouTube' ? [
¬† ¬† ¬† ¬† ¬† ¬† { id: 'uDqjIdI4bF4', title: '12 Principles of Animation' },
¬† ¬† ¬† ¬† ¬† ¬† { id: 'dQw4w9WgXcQ', title: 'Rick Astley' },
¬† ¬† ¬† ¬† ¬† ¬† { id: '9bZkp7q19f0', title: 'Gangnam Style' }
¬† ¬† ¬† ¬† ].map(v => ({...v, img: `https://img.youtube.com/vi/${v.id}/maxresdefault.jpg`})) : [
¬† ¬† ¬† ¬† ¬† ¬† { id: 'ninja', title: 'Ninja', img: 'https://static-cdn.jtvnw.net/jtv_user_pictures/6019313b-a253-488b-a4be-a6750346c483-profile_image-300x300.png' },
¬† ¬† ¬† ¬† ¬† ¬† { id: 'shroud', title: 'Shroud', img: 'https://static-cdn.jtvnw.net/jtv_user_pictures/shroud-profile_image-83ad19f116569766-300x300.png' }
¬† ¬† ¬† ¬† ];
¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† grid.innerHTML = '';
¬† ¬† ¬† ¬† socialData.forEach((item, index) => {
¬† ¬† ¬† ¬† ¬† ¬† const card = document.createElement('div');
¬† ¬† ¬† ¬† ¬† ¬† card.className = 'media-card';
¬† ¬† ¬† ¬† ¬† ¬† card.style.animationDelay = `${index * 0.05}s`;
¬† ¬† ¬† ¬† ¬† ¬† // Pass the current type so openMenu knows if it needs to proxy the player later
¬† ¬† ¬† ¬† ¬† ¬† card.onclick = () => openMenu(item.id, item.title, type);
¬† ¬† ¬† ¬† ¬† ¬† card.innerHTML = `<img src="${item.img}" class="media-img"><div class="hover-overlay"><div class="movie-title">${item.title}</div></div>`;
¬† ¬† ¬† ¬† ¬† ¬† grid.appendChild(card);
¬† ¬† ¬† ¬† });
¬† ¬† ¬† ¬† return;
¬† ¬† }

¬† ¬† let url = searchTerm 
¬† ¬† ¬† ¬† ? `https://api.themoviedb.org/3/search/${type}?api_key=${API_KEY}&query=${searchTerm}`
¬† ¬† ¬† ¬† : `https://api.themoviedb.org/3/${type}/popular?api_key=${API_KEY}`;

    // TMDB is intentionally NOT proxied for stability
// (Proxy is only used for player embeds)

    const res = await fetch(url);
    const data = await res.json();
    grid.innerHTML = '';
    
   for (let index = 0; index < data.results.length; index++) {
  const item = data.results[index];

  // üîû Skip R-rated movies
  if (type === 'movie') {
    const ratedR = await isRatedR(item.id);
    if (ratedR) continue;
  }

  const card = document.createElement('div');
  card.className = 'media-card';
  card.style.animationDelay = `${index * 0.05}s`;
  card.onclick = () => openMenu(item.id, item.title || item.name, type);

  card.innerHTML = `
    <img src="https://image.tmdb.org/t/p/w500${currentView === 'poster' ? item.poster_path : item.backdrop_path}" class="media-img">
    <div class="hover-overlay">
      <div class="hover-content">
        <div class="movie-title">${item.title || item.name}</div>
        <div class="movie-desc">
          ${truncateText(item.overview, 140)}
        </div>
      </div>
    </div>
  `;

  grid.appendChild(card);
}

}

let currentType = 'movie';
let currentSourceUrl = '';

async function openMenu(id, title, type) {
    activeId = id;
    currentType = type;
    document.getElementById('menuTitle').innerText = title;
    document.getElementById('sourceModal').style.display = 'block';
    
    const tvControls = document.getElementById('tvSideControls');
    const folderBtn = document.querySelector('button[onclick="toggleSourcePicker()"]');

    // Reset player display state
    document.getElementById('playerFrame').style.display = 'none';
    document.getElementById('placeholderView').style.display = 'flex';

   // Set default source to Maple TV
if (type === 'tv' || type === 'movie') {
    const maple = availableSources.find(s => s.id === "mapletv");
    currentSourceUrl = maple?.urls[type] || availableSources[0].urls[type];
}


    if (type === 'tv') {
        tvControls.style.display = 'flex';
        folderBtn.style.display = 'flex';
        // Wait for seasons to load before updating player
        await fetchSeasons(id); 
    } else if (type === 'movie') {
        tvControls.style.display = 'none';
        folderBtn.style.display = 'flex';
        updatePlayerSource();
    } else {
        tvControls.style.display = 'none';
        folderBtn.style.display = 'none';
        updatePlayerSource();
    }

    // Check proxy status every time a menu is opened
¬† ¬† const isProxied = document.getElementById('proxyStatus').value === 'uv';
¬† ¬† 
¬† ¬† // Define available servers based on proxy status
¬† ¬† const sourceList = isProxied ? 
¬† ¬† ¬† ¬† [{ id: "mapletv", name: "Maple Tv", urls: { movie: "https://mappletv.uk/watch/movie/{id}", tv: "https://mappletv.uk/watch/tv/{id}-{season}-{episode}" } }] 
¬† ¬† ¬† ¬† : availableSources;

¬† ¬† // Force currentSourceUrl to sync with the proxy choice immediately
¬† ¬† if (type === 'tv' || type === 'movie') {
¬† ¬† ¬† ¬† currentSourceUrl = sourceList[0].urls[type] || availableSources[0].urls[type];
¬† ¬† }

¬† ¬† const picker = document.getElementById('sourcePicker');
    picker.innerHTML = '';
    sourceList.forEach(src => {
        if(!src.urls[type]) return; 
        const a = document.createElement('a');
        a.innerText = src.name;
        a.style = "color: white; padding: 10px; cursor: pointer; border-bottom: 1px solid var(--border); display: block; text-decoration: none;";
        a.onclick = () => {
            currentSourceUrl = src.urls[type];
            updatePlayerSource();
            picker.style.display = 'none';
        };
        picker.appendChild(a);
    });
}

async function fetchSeasons(id) {
    const res = await fetch(`https://api.themoviedb.org/3/tv/${id}?api_key=${API_KEY}`);
    const data = await res.json();
    const select = document.getElementById('seasonSelect');
    select.innerHTML = '';
    data.seasons.forEach(s => {
        if(s.season_number === 0) return; // Skip specials
        const opt = document.createElement('option');
        opt.value = s.season_number;
        opt.innerText = `S${s.season_number}`;
        select.appendChild(opt);
    });
    await fetchEpisodes();
}

async function fetchEpisodes() {
    const seasonSelect = document.getElementById('seasonSelect');
    const seasonNum = seasonSelect.value;
    if(!seasonNum) return;

    const res = await fetch(`https://api.themoviedb.org/3/tv/${activeId}/season/${seasonNum}?api_key=${API_KEY}`);
    const data = await res.json();
    const select = document.getElementById('episodeSelect');
    
    select.innerHTML = '';
    data.episodes.forEach(e => {
        const opt = document.createElement('option');
        opt.value = e.episode_number;
        opt.innerText = `E${e.episode_number}`;
        select.appendChild(opt);
    });
    
    // Only update the player once the episode list is populated
    updatePlayerSource();
}

let pendingUrl = ""; 

function updatePlayerSource() {
    const player = document.getElementById('playerFrame');
    const placeholder = document.getElementById('placeholderView');
    const isProxied = document.getElementById('proxyStatus').value === 'uv';
    
    // Reset state before logic
    player.style.display = 'none';
    player.src = '';
    placeholder.style.display = 'flex';
    pendingUrl = "";

    let finalUrl = "";

    if (currentType === 'YouTube') {
        finalUrl = `https://www.youtube.com/embed/${activeId}?autoplay=1`;
    } else if (currentType === 'Twitch') {
        finalUrl = `https://player.twitch.tv/?channel=${activeId}&parent=${window.location.hostname}`;
    } else {
        if (!currentSourceUrl) return;
        const season = document.getElementById('seasonSelect').value || 1;
        const episode = document.getElementById('episodeSelect').value || 1;
        
        let rawUrl = currentSourceUrl
            .replace(/{id}/g, activeId)
            .replace(/{season}/g, season)
            .replace(/{episode}/g, episode);

       // Proxied mode = external launch only (no URL modification)
finalUrl = rawUrl;

    }

    // Logic for Launch Button vs Auto-Play
    if (finalUrl) {
        // If Proxied and NOT YouTube/Twitch, show the button
        if (isProxied && currentType !== 'YouTube' && currentType !== 'Twitch') {
            pendingUrl = finalUrl;
            placeholder.innerHTML = `
                <h2 style="margin-bottom:10px;">Source Ready</h2>
                <button onclick="launchMedia()" style="padding:12px 25px; background:var(--accent); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold; font-size:16px; box-shadow: 0 4px 15px rgba(58,160,255,0.3);">
                    üöÄ Launch in New Tab
                </button>
                <p style="opacity: 0.5; font-size:12px; margin-top:15px;">Proxied mode requires external window but is unblocked.</p>
            `;
        } else {
            // Keep original behavior for YouTube, Twitch, and standard Movies
            player.src = finalUrl;
            player.style.display = 'block';
            placeholder.style.display = 'none';
        }
    }
}

function launchMedia() {
    if (pendingUrl) {
        window.open(pendingUrl, '_blank');
    }
}

function toggleSourcePicker() {
    const picker = document.getElementById('sourcePicker');
    picker.style.display = (picker.style.display === 'none' || picker.style.display === '') ? 'flex' : 'none';
}

function toggleIframeFullscreen() {
    const frame = document.getElementById('playerFrame');
    if (frame.requestFullscreen) frame.requestFullscreen();
    else if (frame.webkitRequestFullscreen) frame.webkitRequestFullscreen();
}

function closeMenu() {
    document.getElementById('sourceModal').style.display = 'none';
    document.getElementById('playerFrame').src = '';
    document.getElementById('playerFrame').style.display = 'none';
    document.getElementById('placeholderView').style.display = 'flex';
}

function toggleView(view) {
    currentView = view;
    const grid = document.getElementById('mediaGrid');
    if(view === 'banner') grid.classList.add('banner-view');
    else grid.classList.remove('banner-view');
    fetchMovies(document.getElementById('movieSearch').value);
}

// Initialize the app correctly
fetchMovies();
auth.onAuthStateChanged(user => {
  if (!user) {
    window.location.href = "index.html";
    return;
  }

  db.collection("users").doc(user.uid).get().then(doc => {
    if (doc.exists && doc.data().photoURL) {
      document.getElementById("userProfilePic").style.backgroundImage =
        `url('${doc.data().photoURL}')`;
    }
  });
});

  </script>
</body>
</html>